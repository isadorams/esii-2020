<?php

namespace DAO;
/**
 * Classe DAO do Usurio
 *  Esta classe  responsvel por fazer a comunicao com o banco de dados
 *  promovendo as funes de logar e incluir novos usurios
 * @author Isadora M. Skibinski 
 */

 mysqli_report(MYSQLI_REPORT_STRICT);
 require_once('../models/usuarios.php');
 use model\usuarios;
 class DAOUsuario{
     /**
      * Loga um novo usurio no banco de dados 
      *@param string $nome Nome do usurio
      *@param string $email email do usuario
      *@param string $login login do usuario
      *@param string $senha senha do usuario
      *@return TRUE|Exception TRUE para incluso bem sucedida ou Exdeption para a incluso mal sucedida
      */
    public function logar($logar,$senha){
        try{
            $connDB = $this->conectarBanco();
        }catch(\Exception $e){
            die($e->getMessage());
        }

        $usuario = new usuarios();
        $sql = $connDB->prepare('select login,nome,email,celular from usuarios where login = ? and senha = ?');
        $sql->bind_param('ss',$login,$senha);
        $sql->execute();
        if(!$sql->error){
            $resultado = $sql->get_result();
            if($resultado->num_rows === 0){
                $usuario->addUsuario(null,null,null,FALSE);
                throw new \Exception('Usurio ou senha invlidos');
            }else{
                while($linha = $resultado->fetch_assoc()){
                    $usuario->addUsuario($login['login'],$nome['nome'],$email['email'],$celular['celular'], TRUE);
                }
                return $usuario;
            }
        }else{
            throw new \Exception('Erro ao executar busca com os dados fornecidos');
        }

        
        $sql->close();
        $connDB->close();
    }

    /**
      * Inclui um novo usurio no banco de dados 
      *@param usuarios $usuario objeto do tipo usuario que dever ser cadastrado
      *@return TRUE|Exception TRUE para incluso bem sucedida ou Exdeption para a incluso mal sucedida
      */
      public function incluirUsuario($nome,$email,$login,$senha){
        try{
            $connDB = $this->conectarBanco();
        }catch(\Exception $e){
            die($e->getMessage());
        }

        $sqlInsert = $connDB->conectarBanco('insert into usuario nome,email,login,senha,values(?,?,?,?)');
        $$sqlInsert->execute();
        if(!$sqlInsert->error){
           $retorno = TRUE;
        }else{
            throw new \Exception('Erro ao incluir novo usurio');
        }
        $sqlInsert->close();
        $connDB->close();
        return $retorno;
    }
    
    public function conectarBanco(){
        $ds = DIRECTORY_SEPARATOR;
        $base_dir = dirname(_FILE_).ds);

        require(base_dir.'bd_config.php');

        try{
            $conn = new \MySQLi($dbhost,$user,$password,$db);
            return $conn;
        }catch(mysqli_sql_exception $e){
            throw new \Exception($e);
            die;
        }
    }
 }
?>